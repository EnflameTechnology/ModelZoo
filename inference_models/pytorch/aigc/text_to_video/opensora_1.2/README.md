# OpenSora V1.2 æ¨¡å‹æ¨ç†æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£ä»‹ç»åœ¨ Enflame GCU ä¸ŠåŸºäº pytorch native è¿›è¡Œ opensora_1.2 çš„ image2video ä»»åŠ¡çš„æ¨ç†åŠæ€§èƒ½è¯„ä¼°è¿‡ç¨‹

## æ¨¡å‹è¯´æ˜

Open-Sora 1.2 åœ¨ 720p é«˜æ¸…æ–‡ç”Ÿè§†é¢‘è´¨é‡å’Œç”Ÿæˆæ—¶é•¿ä¸Šå–å¾—äº†çªç ´æ€§è¿›å±•ï¼Œæ”¯æŒæ— ç¼äº§å‡ºä»»æ„é£æ ¼çš„é«˜è´¨é‡çŸ­ç‰‡ã€‚å…¶æŠ€æœ¯äº®ç‚¹åŒ…æ‹¬ï¼š
- è§†é¢‘å‹ç¼©ç½‘ç»œ

  Open-Sora å›¢é˜Ÿæå‡ºäº†ä¸€ä¸ªåˆ›æ–°çš„è§†é¢‘å‹ç¼©ç½‘ç»œï¼ˆVAEï¼‰ï¼Œè¯¥ç½‘ç»œåœ¨ç©ºé—´å’Œæ—¶é—´ä¸¤ä¸ªç»´åº¦ä¸Šåˆ†åˆ«è¿›è¡Œå‹ç¼©ã€‚é¦–å…ˆåœ¨ç©ºé—´ç»´åº¦ä¸Šè¿›è¡Œ 8x8 å€çš„å‹ç¼©ï¼Œæ¥ç€åœ¨æ—¶é—´ç»´åº¦ä¸Šè¿›ä¸€æ­¥å‹ç¼©äº† 4 å€ã€‚è¿™ç§åˆ›æ–°çš„å‹ç¼©ç­–ç•¥æ—¢é¿å…äº†å› æŠ½å¸§è€Œç‰ºç‰²è§†é¢‘æµç•…åº¦çš„å¼Šç«¯ï¼Œåˆå¤§å¹…é™ä½äº†è®­ç»ƒæˆæœ¬ï¼Œå®ç°äº†æˆæœ¬ä¸è´¨é‡çš„åŒé‡ä¼˜åŒ–ã€‚

  ![alt text](Open_Sora_1.2_VAE.png)
  * å›¾ç‰‡æ¥æºï¼š[report_v3.md](https://github.com/hpcaitech/Open-Sora/blob/main/docs/zh_CN/report_v3.md)

- æ•´æµæµå’Œæ¨¡å‹é€‚åº”

  æœ€æ–°çš„æ‰©æ•£æ¨¡å‹ Stable Diffusion 3 ä¸ºäº†è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œé‡‡ç”¨äº†rectified flowæ›¿ä»£äº† DDPMã€‚å¯æƒœ SD3 çš„ rectified flow è®­ç»ƒä»£ç æ²¡æœ‰å¼€æºã€‚Open-Sora 1.2 å®ç°äº† SD3 è®ºæ–‡ä¸­çš„è®­ç»ƒç­–ç•¥ï¼ŒåŒ…æ‹¬ï¼š
  * åŸºæœ¬æ•´æµæµè®­ç»ƒ
  * ç”¨äºè®­ç»ƒåŠ é€Ÿçš„ Logit-norm é‡‡æ ·
  * åˆ†è¾¨ç‡å’Œè§†é¢‘é•¿åº¦æ„ŸçŸ¥æ—¶é—´æ­¥é•¿é‡‡æ ·

  è¿™äº›ç­–ç•¥ä¿ç•™äº†åŸå§‹æ¨¡å‹ç”Ÿæˆé«˜è´¨é‡å›¾åƒçš„èƒ½åŠ›ï¼Œå¹¶æœªåç»­çš„è§†é¢‘ç”Ÿæˆæä¾›äº†è®¸å¤šåŠ©åŠ›ï¼š

  * é€šè¿‡æ•´æµï¼ŒåŠ é€Ÿäº†æ¨¡å‹è®­ç»ƒï¼Œå¤§å¹…å‡å°‘äº†æ¨ç†çš„ç­‰å¾…æ—¶é—´ã€‚
  * ä½¿ç”¨ qk-normï¼Œè®­ç»ƒæ›´åŠ ç¨³å®šï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ç§¯æçš„ä¼˜åŒ–å™¨ã€‚
  * é‡‡ç”¨æ–°çš„ VAEï¼Œæ—¶é—´ç»´åº¦å‹ç¼©äº†4å€ï¼Œä½¿å¾—è®­ç»ƒæ›´åŠ é«˜æ•ˆã€‚
  * è¯¥æ¨¡å‹å…·æœ‰å¤šåˆ†è¾¨ç‡å›¾åƒç”Ÿæˆèƒ½åŠ›ï¼Œå¯ä»¥ç”Ÿæˆä¸åŒåˆ†è¾¨ç‡çš„è§†é¢‘ã€‚

æ­¤å¤– Open-Sora 1.2 è¿˜é‡‡ç”¨äº†æ›´å¤šæ•°æ®å’Œæ›´å¥½çš„å¤šé˜¶æ®µè®­ç»ƒç­–ç•¥ï¼Œè®¾è®¡äº†æ›´å¥½çš„è¯„ä¼°æŒ‡æ ‡ï¼Œä¿éšœäº†æ¨¡å‹çš„ç¨³å¥æ€§å’Œæ³›åŒ–èƒ½åŠ›ã€‚

|      | å›¾åƒ | 2ç§’  | 4ç§’  | 8ç§’  | 16ç§’ |
| ---- | ----- | --- | --- | --- | --- |
| 240p | âœ…     | âœ…   | âœ…   | âœ…   | âœ…   |
| 360p | âœ…     | âœ…   | âœ…   | âœ…   | âœ…   |
| 480p | âœ…     | âœ…   | âœ…   | âœ…   | ğŸ†—   |
| 720p | âœ…     | âœ…   | âœ…   | ğŸ†—   | ğŸ†—   |

è¿™é‡Œâœ…è¡¨ç¤ºåœ¨è®­ç»ƒæœŸé—´å¯ä»¥çœ‹åˆ°æ•°æ®ï¼ŒğŸ†—è¡¨ç¤ºè™½ç„¶æ²¡æœ‰ç»è¿‡è®­ç»ƒï¼Œä½†æ¨¡å‹å¯ä»¥åœ¨è¯¥é…ç½®ä¸‹è¿›è¡Œæ¨ç†ã€‚ğŸ†—çš„æ¨ç†éœ€è¦å¤šä¸ª80Gå†…å­˜çš„GPUå’Œåºåˆ—å¹¶è¡Œã€‚

Open-Sora 1.2 èƒ½å¤Ÿç”Ÿæˆæ—¶é•¿ 16 ç§’ã€åˆ†è¾¨ç‡ 720p çš„é«˜æ¸…è§†é¢‘ï¼Œå¹¶æ”¯æŒç”Ÿæˆå„ç§é£æ ¼çš„çŸ­ç‰‡ï¼Œä¾‹å¦‚æµ·æµªã€æ£®æ—ã€äººç‰©è‚–åƒã€èµ›åšæœ‹å…‹ã€åŠ¨ç”»ç­‰ã€‚æ­¤å¤–ï¼ŒOpen-Sora 1.2 è¿˜æ”¯æŒå›¾åƒåˆ°è§†é¢‘çš„ç”Ÿæˆå’Œè§†é¢‘æ‰©å±•åŠŸèƒ½ã€‚

## ç¯å¢ƒé…ç½®

ä»¥ä¸‹æ­¥éª¤åŸºäº `Python3.10`, è¯·å…ˆå®‰è£…æ‰€éœ€ä¾èµ–ï¼š

* å®‰è£…ç¯å¢ƒï¼šå®‰è£…è¿‡ç¨‹è¯·å‚è€ƒã€ŠTopsRider è½¯ä»¶æ ˆå®‰è£…æ‰‹å†Œã€‹ï¼Œè¯·æ ¹æ®æ‰‹å†Œå®Œæˆ TopsRider è½¯ä»¶æ ˆå®‰è£…

- å®‰è£… torch_gcu

  **æ³¨æ„**ï¼šå®‰è£… torch_gcu-2.3.0 ä¼šè‡ªåŠ¨å®‰è£… torch 2.3.0

  ```bash
  # éœ€è¦ä½¿ç”¨ root æƒé™
  ./TopsRider_{filename}.run -y -C torch-gcu-2
  ```

- å®‰è£…ä¾èµ–

  è¿›å…¥ opensora æ ¹ç›®å½•ï¼Œæ‰§è¡Œï¼š

  ```bash
  pip3 install -r requirements.txt
  ```

## å‡†å¤‡æ¨¡å‹

* ä¸‹è½½é¢„è®­ç»ƒæ¨¡å‹ï¼š

  è¯·ä» [OpenSora-STDiT-v3](https://huggingface.co/hpcai-tech/OpenSora-STDiT-v3/tree/main) è·¯å¾„ä¸‹ä¸‹è½½å…¨éƒ¨å†…å®¹åˆ°æ¨¡å‹å­˜æ”¾ç›®å½•ï¼Œä»¥ä¸‹ç”¨ `path_to_dit_dir` è¡¨ç¤ºå…¶è·¯å¾„
  - branch: `main`
  - commit id: `9a8583918505ee93bd9fae8dd5ce32e1f9334c71`

  è¯·ä» [t5-v1_1-xxl](https://huggingface.co/DeepFloyd/t5-v1_1-xxl/tree/main) è·¯å¾„ä¸‹ä¸‹è½½å…¨éƒ¨å†…å®¹åˆ°æ¨¡å‹å­˜æ”¾ç›®å½•ï¼Œä»¥ä¸‹ç”¨ `path_to_t5_dir` è¡¨ç¤ºå…¶è·¯å¾„
  - branch: `main`
  - commit id: `c9c625d2ec93667ec579ede125fd3811d1f81d37`

  è¯·ä» [pixart_sigma_sdxlvae_T5_diffusers](https://huggingface.co/PixArt-alpha/pixart_sigma_sdxlvae_T5_diffusers/tree/main) è·¯å¾„ä¸‹ä¸‹è½½å…¨éƒ¨å†…å®¹åˆ°æ¨¡å‹å­˜æ”¾ç›®å½•ï¼Œä»¥ä¸‹ç”¨ `path_to_vae2d_dir` è¡¨ç¤ºå…¶è·¯å¾„
  - branch: `main`
  - commit id: `2c17b4e85261cd549b4068d086b7c2ba9d468e9f`

  è¯·ä» [OpenSora-VAE-v1.2](https://huggingface.co/hpcai-tech/OpenSora-VAE-v1.2/tree/main) è·¯å¾„ä¸‹ä¸‹è½½å…¨éƒ¨å†…å®¹åˆ°æ¨¡å‹å­˜æ”¾ç›®å½•ï¼Œä»¥ä¸‹ç”¨ `path_to_vae3d_dir` è¡¨ç¤ºå…¶è·¯å¾„
  - branch: `main`
  - commit id: `33d153e9b5a9f771a8a84f98bd3f46458a8ed0bf`

## æ‰§è¡Œæ¨ç†

ä½¿ç”¨ opensora_1.2 è¿›è¡Œæ¨ç†ï¼Œè¿›å…¥ opensora_1.2 æ ¹ç›®å½•ï¼Œæ‰§è¡Œï¼š

``` bash
python3 demo_open_sora.py \
--device gcu \
--ckpt-path-dit $path_to_dit_dir \
--ckpt-path-t5 $path_to_t5_dir \
--ckpt-path-vae2d $path_to_vae2d_dir \
--ckpt-path-vae3d $path_to_vae3d_dir \
--num-frames 2s \
--resolution 144p \
--sample-name "2s-gcu-144p" \
--aspect-ratio 9:16 \
--prompt "a beautiful waterfall."
```

å…¶ä¸­ï¼Œ

- `--ckpt-path-dit`: opensora dit çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--ckpt-path-t5`: opensora t5_xxl æ–‡æœ¬ç¼–ç æ¨¡å‹æ‰€åœ¨ç›®å½•
- `--ckpt-path-vae2d`: opensora vae2d çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--ckpt-path-vae3d`: opensora vae3d çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--num-frames`: ç”Ÿæˆè§†é¢‘çš„ç§’æ•°ï¼Œ
- `--resolution`: ç”Ÿæˆè§†é¢‘å¾—åˆ†è¾¨ç‡
- `--aspect-ratio`: ç”Ÿæˆè§†é¢‘çš„é•¿å®½æ¯”
- `--sample-name`: ä¿å­˜ç”Ÿæˆçš„åå­—

å…¶å®ƒå‚æ•°åŠå…¶å«ä¹‰è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

``` bash
python3 demo_open_sora.py -h
```



## æ€§èƒ½è¯„ä¼°

å¯¹ opensora_1.2 144p è¿›è¡Œ image2video æ€§èƒ½è¯„ä¼°ï¼Œè¿›å…¥ opensora_1.2 æ ¹ç›®å½•ï¼Œæ‰§è¡Œï¼š

```bash
python3 benchmark_open_sora.py \
--device gcu \
--ckpt-path-dit $path_to_dit_dir \
--ckpt-path-t5 $path_to_t5_dir \
--ckpt-path-vae2d $path_to_vae2d_dir \
--ckpt-path-vae3d $path_to_vae3d_dir \
--num-frames 2s \
--resolution 144p \
--sample-name "2s-gcu-144p" \
--aspect-ratio 9:16 \
--prompt "a beautiful waterfall." \
--benchmark-save-path './benchmark/report-opensora-v1.2.json' \
--warmup-count 3 \
--eval-count 5
```

å…¶ä¸­ï¼Œ

- `--ckpt-path-dit`: opensora dit çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--ckpt-path-t5`: opensora t5_xxl æ–‡æœ¬ç¼–ç æ¨¡å‹æ‰€åœ¨ç›®å½•
- `--ckpt-path-vae2d`: opensora vae2d çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--ckpt-path-vae3d`: opensora vae3d çš„é¢„è®­ç»ƒæ¨¡å‹æ‰€åœ¨çš„ç›®å½•
- `--num-frames`: ç”Ÿæˆè§†é¢‘çš„ç§’æ•°ï¼Œ
- `--resolution`: ç”Ÿæˆè§†é¢‘å¾—åˆ†è¾¨ç‡
- `--aspect-ratio`: ç”Ÿæˆè§†é¢‘çš„é•¿å®½æ¯”
- `--sample-name`: ä¿å­˜ç”Ÿæˆçš„åå­—

å…¶å®ƒå‚æ•°åŠå…¶å«ä¹‰è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š

``` bash
python3 benchmark_open_sora.py -h
```
